# QuizBattle

QuizBattle is an online quiz game with realtime rooms, account system, friends/invites, profile cosmetics, rating, and a solo `quick-game` mode.

Frontend: `Next.js 16 + React 19 + TypeScript + Tailwind`

Backend: `FastAPI + PostgreSQL + Redis + WebSocket runtime`

## Features
- Create a room with:
  - preset topic
  - custom topic generated by AI
  - `5`, `6`, or `7` questions
  - difficulty: `easy`, `medium`, `hard`, `progressive`
  - mode: `classic`, `ffa`, `chaos`
  - optional password
- Realtime room flow:
  - lobby
  - team reveal
  - captain vote
  - team naming
  - question
  - reveal
  - results
- Solo `quick-game` mode without room or host
- Auth with email verification
- Friends, invitations, and friends leaderboard
- Profile page, shop, avatar frames, mascot skins, victory effects
- Rating and profile wins tracking
- AI question generation with provider fallback
- Room state snapshots and game result persistence

## Game modes
- `classic`
  - team play with host
  - winning team gets wins
- `chaos`
  - team play with host
  - winning team gets wins
- `ffa`
  - everyone plays for themselves
  - all players tied for top score get a win
- `quick-game`
  - solo mode
  - earned points convert to currency `1:1`
  - reward is claimed on backend once per run

## Question sources
QuizBattle supports two sources of questions:

1. Built-in catalog  
Questions are loaded from:
- [questions_by_difficulty.json](/home/user/Desktop/123/quizbattle/public/questions_by_difficulty.json)

2. AI generation  
If the user enters a custom topic that is not in the built-in catalog, backend tries to generate a JSON set of questions through AI providers. Providers are tried one by one until one succeeds.

Temporary generated question files are removed automatically after the game finishes or the room is cleaned up.

## Project structure
### Frontend
- [src/app/page.tsx](/home/user/Desktop/123/quizbattle/src/app/page.tsx)  
  Main page: create room, join room, AI topic fallback UI
- [src/app/quick-game/page.tsx](/home/user/Desktop/123/quizbattle/src/app/quick-game/page.tsx)  
  Solo quick game
- [src/app/profile/page.tsx](/home/user/Desktop/123/quizbattle/src/app/profile/page.tsx)  
  Profile, cosmetics, avatar frame rendering
- [src/app/rating/page.tsx](/home/user/Desktop/123/quizbattle/src/app/rating/page.tsx)  
  Global rating
- `src/components/*`  
  Shared UI, friends modal, alerts, lists
- `src/shared/*`  
  API helpers, shop, profile hooks

### Backend
- [backend/app/application.py](/home/user/Desktop/123/quizbattle/backend/app/application.py)  
  FastAPI app setup
- [backend/app/runtime.py](/home/user/Desktop/123/quizbattle/backend/app/runtime.py)  
  Main realtime room runtime
- [backend/app/runtime_phase_flow.py](/home/user/Desktop/123/quizbattle/backend/app/runtime_phase_flow.py)  
  Phase transitions
- [backend/app/runtime_question_flow.py](/home/user/Desktop/123/quizbattle/backend/app/runtime_question_flow.py)  
  Question / reveal / results flow
- [backend/app/runtime_state_builders.py](/home/user/Desktop/123/quizbattle/backend/app/runtime_state_builders.py)  
  State/result payload builders
- [backend/app/runtime_snapshot.py](/home/user/Desktop/123/quizbattle/backend/app/runtime_snapshot.py)  
  Snapshot persistence
- [backend/app/question_generation.py](/home/user/Desktop/123/quizbattle/backend/app/question_generation.py)  
  AI question generation and provider fallback
- [backend/app/api/rooms.py](/home/user/Desktop/123/quizbattle/backend/app/api/rooms.py)  
  Room API and quick-game API
- [backend/app/auth_api.py](/home/user/Desktop/123/quizbattle/backend/app/auth_api.py)  
  Auth, shop, profile
- [backend/app/auth_repository.py](/home/user/Desktop/123/quizbattle/backend/app/auth_repository.py)  
  DB operations for auth, coins, wins, inventory
- [backend/app/database.py](/home/user/Desktop/123/quizbattle/backend/app/database.py)  
  DB init and tables

## Requirements
- Node.js 20+
- Python 3.11+
- Docker + Docker Compose

## Quick start
### 1. Install dependencies
```bash
npm install
pip install -r backend/requirements.txt
```

### 2. Configure environment
Create `.env` in project root.

Minimum local setup:
```env
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/quizbattle
REDIS_URL=redis://localhost:6379/0
WS_PORT=3001
MAX_PLAYERS=20

NEXT_PUBLIC_API_BASE_URL=http://localhost
NEXT_PUBLIC_WS_URL=ws://localhost/api/ws
```

### 3. Start local database
```bash
npm run backend:db
```

### 4. Start app in dev mode
```bash
npm run dev
```

Open:
- `http://localhost:3000`

`npm run dev` starts:
- Next.js frontend
- Python backend on port `3001`

## Full Docker stack
Run full stack:
```bash
npm run stack:up
```

Stop:
```bash
npm run stack:down
```

Logs:
```bash
npm run stack:logs
```

Services:
- `frontend`
- `backend-python`
- `postgres`
- `redis`
- `nginx`

Public entrypoint:
- `http://localhost:3000`

## Backend-only stack
```bash
npm run backend:stack:up
```

Stop:
```bash
npm run backend:stack:down
```

## Useful scripts
```bash
npm run dev
npm run build
npm run start
npm run lint
npm run ws-server
npm run test:ws-load
```

## Environment variables
### Core
- `DATABASE_URL`
- `REDIS_URL`
- `WS_PORT`
- `MAX_PLAYERS`
- `NEXT_PUBLIC_API_BASE_URL`
- `NEXT_PUBLIC_WS_URL`

### Auth / email
- `EMAIL_TRANSPORT`
- `CODE_TTL_SECONDS`
- `RESEND_COOLDOWN_SECONDS`
- `SMTP_HOST`
- `SMTP_PORT`
- `SMTP_USER`
- `SMTP_PASS`
- `SMTP_FROM`
- `SMTP_USE_SSL`
- `RESEND_API_KEY`
- `RESEND_FROM`
- `RESEND_API_URL`

### AI question generation
- `AI_QUESTION_TIMEOUT_SECONDS`
- `AI_QUESTION_TEMPERATURE`
- `QUICK_GAME_REWARD_SECRET`

Provider fallback supports up to 6 providers:
- `AI_QUESTION_PROVIDER_1_NAME`
- `AI_QUESTION_PROVIDER_1_URL`
- `AI_QUESTION_PROVIDER_1_MODEL`
- `AI_QUESTION_PROVIDER_1_KEY`
- `AI_QUESTION_PROVIDER_1_REFERER`
- `AI_QUESTION_PROVIDER_1_TITLE`

Repeat the same pattern for `_2` ... `_6`.

Example:
```env
AI_QUESTION_TIMEOUT_SECONDS=60
AI_QUESTION_TEMPERATURE=0.8
QUICK_GAME_REWARD_SECRET=change-me

AI_QUESTION_PROVIDER_1_NAME=groq-70b
AI_QUESTION_PROVIDER_1_URL=https://api.groq.com/openai/v1/chat/completions
AI_QUESTION_PROVIDER_1_MODEL=llama-3.3-70b-versatile
AI_QUESTION_PROVIDER_1_KEY=your_groq_key

AI_QUESTION_PROVIDER_2_NAME=openrouter-deepseek
AI_QUESTION_PROVIDER_2_URL=https://openrouter.ai/api/v1/chat/completions
AI_QUESTION_PROVIDER_2_MODEL=deepseek/deepseek-chat
AI_QUESTION_PROVIDER_2_KEY=your_openrouter_key
AI_QUESTION_PROVIDER_2_REFERER=http://localhost:3000
AI_QUESTION_PROVIDER_2_TITLE=QuizBattle
```

## Persistence
### PostgreSQL
Backend stores:
- auth users
- auth sessions
- email codes
- shop inventory
- wins
- room snapshots
- game results
- quick-game reward claims
- friendships and room invitations

### Redis
Used for room snapshot caching and hot state sync support.

## Currency and wins
### Currency
- `classic`, `chaos`, `ffa`
  - coins are awarded on backend after game results
  - rewards are based on earned points
- `quick-game`
  - total earned points convert to currency `1:1`
  - reward is validated and claimed on backend once

### Wins
- `classic`, `chaos`
  - all registered players in the winning team get `+1`
- `ffa`
  - all registered players tied for highest score get `+1`
- `quick-game`
  - does not affect wins/rating

## AI generation notes
- Custom topic generation is backend-driven.
- Frontend only sends requested topic/difficulty/count.
- If all AI providers fail, frontend falls back to preset topics.
- Provider failures are logged in backend as:
  - `question_generation attempt=...`
  - `question_generation failed ... reason=...`

Useful command:
```bash
docker logs quizbattle-backend-python --tail=200 | rg "question_generation|reason="
```

## Testing and checks
Python syntax check:
```bash
python3 -m py_compile backend/app/*.py backend/app/api/*.py
```

TypeScript check:
```bash
npx tsc --noEmit
```

Load test:
```bash
npm run test:ws-load
```

## Known implementation details
- Room state is server-authoritative.
- WebSocket state updates are broadcast by backend runtime.
- Snapshot persistence is split between Redis and PostgreSQL.
- AI-generated question sets are temporary and cleaned up automatically.
- Quick-game rewards are protected by backend-signed one-time reward tokens.

## Security notes
- Do not commit real API keys to `.env`.
- If keys were exposed in logs, screenshots, or chat, rotate them.
- Set a strong `QUICK_GAME_REWARD_SECRET` outside development.

## License
No license file is included in this repository.
